\documentclass{jsarticle}
\usepackage{amsmath}
\usepackage{bm}
\usepackage{xparse}

\makeatletter

\renewcommand{\d}{\textrm{d}}

% 常微分マクロ
\NewDocumentCommand\odr{m O{} m}{%
	\frac{%
		\d^{#2} #3%
	}{%
		\d #1^{#2}%
	}%
}

% 階数を計算するためのカウンタ
\newcounter{@derivative@totalOrder}
% 階数を計算
\newcommand{\@derivative@addToTotalOrder}[1]{%
	\ifx\hfuzz#1\hfuzz% 空の場合
		\addtocounter{@derivative@totalOrder}{1}%
	\else%
		\addtocounter{@derivative@totalOrder}{#1}%
	\fi%
}
% 階数を表示
\newcommand{\@derivative@printTotalOrder}{%
	\ifnum\value{@derivative@totalOrder}=1% 階数が1の場合
		% 空
	\else%
		\the@derivative@totalOrder% 階数を表示
	\fi%
}
% 階数をリセット
\newcommand{\@derivative@resetTotalOrder}{%
	\setcounter{@derivative@totalOrder}{0}%
}

% version1
% https://zrbabbler.hatenablog.com/entry/20110903/1315024613
% 偏微分の分母と分子を一時的に保存
\newcommand{\@derivative@denominator}{\relax} % 分母
\newcommand{\@derivative@numerator}{\relax} % 分子
% 一つずつ読み取っていく
\NewDocumentCommand\@pdr{m O{} m}{%
	\ifx#3\@pdr@end% 分母処理(最終)
		\renewcommand{\@derivative@numerator}{\partial^{\@derivative@printTotalOrder} #1}%
	\else% 分子処理
		\@derivative@addToTotalOrder{#2}% 階数に足しこむ
		\expandafter\renewcommand\expandafter\@derivative@denominator\expandafter{\@derivative@denominator \partial #1^{#2}}% 分母更新
		\expandafter\@pdr\expandafter{\expandafter#3\expandafter}% 再帰 \fiを正常に動かすためにexpandafterをつける
	\fi
}

% version2
\newcommand{\@derivative@lastarg@}{\hfuzz}
\newcommand{\@derivative@lastarg@@}{0}
% 一つずつ読み取っていく
\NewDocumentCommand\@pdr@{m O{}}{%
	\ifx#1\@pdr@end% 分子処理(最終)
		\renewcommand{\@derivative@numerator}{\partial^{\@derivative@printTotalOrder} \@derivative@lastarg@}% 分子更新
		%
	\else% 分母処理
		\expandafter\ifx\@derivative@lastarg@\hfuzz% lastarg@を先に展開し、その中身がhfuzzならば1つ目の引数処理
		\else%
			\expandafter\@derivative@addToTotalOrder\expandafter{\@derivative@lastarg@@}% 階数に足しこむ
			\edef\@derivative@denominator{\@derivative@denominator \partial \@derivative@lastarg@^{\@derivative@lastarg@@}}% 分母更新
		\fi%
		\renewcommand{\@derivative@lastarg@}{#1}%
		\renewcommand{\@derivative@lastarg@@}{#2}%
		\expandafter\@pdr@% 再帰 \fiを正常に動かすためにexpandafterをつける
	\fi
}


% 終了判定用
\newcommand{\@pdr@end}{\@pdr@end@}

\newcommand{\pdr}[2][1]{%
	\@derivative@resetTotalOrder%
	\ifnum#1=1%
		\@pdr#2\@pdr@end%
	\else%
		\@pdr@#2\@pdr@end%
	\fi%
	\frac{\@derivative@numerator}{\@derivative@denominator}%
}

%TODO 階数に文字式が指定された場合は正常に動作しないはずなので修正

\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% physicsパッケージの偏微分マクロは$\displaystyle \frac{\partial^5 f}{\partial x^2 \partial y^3}$
% のようなものに対応しておらず、
% 使い勝手が微妙に悪いので、自作する
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{document}
\tracingonline=1
\tracingmacros=1
\tracingcommands=1

常微分マクロ\verb|\odr|
\begin{align}
	\odr{x}{f} \\
	\odr{x}[2]{f} \\
	\odr{x}[n]{f} \\
	\odr{x_1}{f} \\
	\odr{x_1}{y_2} \\
	\odr{t}{\bm{u}} \\
	\odr{\bm{x}}{f}
\end{align}

偏微分マクロ\verb|\pdr| version 1
\begin{align}
	\pdr{{x}{f}} \\ 				% pass
	\pdr{{x}[2]{f}} \\ 				% pass
	\pdr{{x}{y}{f}} \\ 				% pass
	\pdr{{x}[2]{y}{f}} \\ 			% pass
	\pdr{{x}[2]{y}[3]{f}} \\ 		% pass
	\pdr{{x_1}{y}} \\ 				% pass
%	\pdr{{x_1}{x_2}{f}} \\ 			% FAIL
%	\pdr{{x}{f_2}} \\ 				% FAIL
	\pdr{{\bm{x}}{f}} \\ 			% pass
%	\pdr{{\bm{x}}{\bm{y}}{f}} \\ 	% FAIL
%	\pdr{{x}[2]{\bm{u}}} \\ 		% FAIL
\end{align}

偏微分マクロ\verb|\pdr| version 2
\begin{align}
	\pdr[2]{{x}{f}} \\ 				% pass
	\pdr[2]{{x}[2]{f}} \\ 			% pass
	\pdr[2]{{x}{y}{f}} \\ 			% pass
	\pdr[2]{{x}[2]{y}{f}} \\ 		% pass
	\pdr[2]{{x}[2]{y}[3]{f}} \\ 	% pass
	\pdr[2]{{x_1}{y}} \\ 			% pass
	\pdr[2]{{x_1}{x_2}{f}} \\ 		% pass
	\pdr[2]{{x}{f_2}} \\ 			% pass
%	\pdr[2]{{\bm{x}}{f}} \\ 		% FAIL
%	\pdr[2]{{\bm{x}}{\bm{y}}{f}} \\ % FAIL
	\pdr[2]{{x}[2]{\bm{u}}} \\ 		% pass
\end{align}



%
%\pdr{
%	{x}{y}{f}
%}
%
%\pdr{{x}{y}{f}}




\end{document}